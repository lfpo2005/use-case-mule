<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:kafka="http://www.mulesoft.org/schema/mule/kafka"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="implementation-post-create-account-main"
		doc:id="58699980-a05e-425c-b68f-a092f57b6abc">
		<flow-ref doc:name="Flow Reference"
			doc:id="834adebe-9a73-4fd8-8969-e7e7671aad52"
			name="implementation-post-create-account" />
		<flow-ref doc:name="Flow Reference"
			doc:id="923dfcc1-d1f6-40e8-9c3a-d5d3ed4c50e5"
			name="post-create-account-return" />
	</sub-flow>
	<sub-flow name="post-create-account-return"
		doc:id="ce0b163d-5d0c-402a-8c33-29ccca53e7cf">
		<db:select config-ref="Database_Config"
			doc:name="Get Number Accout">
			<db:sql><![CDATA[SELECT
numero_conta,
nome
FROM mule_conta
WHERE conta_id = :conta_id]]></db:sql>
			<db:input-parameters><![CDATA[#[{'conta_id': vars.currentItem.contaId}]]]></db:input-parameters>
		</db:select>

		<ee:transform doc:name="Transform Message"
			doc:id="b279d26f-8d3e-41f8-9c5e-e9e86b7c782d">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "status": "success",
  "message": "Conta criada com sucesso",
  "Numero da conta": payload.numero_conta[0],
  "Nome": payload.nome[0]
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="implementation-post-create-account"
		doc:id="8db8595c-3f7c-4a24-a0e4-ff64a5c43c8f">
		<http:request method="POST"
			config-ref="HTTP_Request_config" path="/contas"
			doc:name="Create Account">
			<http:body><![CDATA[#[output application/json
            ---
            {
                nome: payload.nome
            }]]]></http:body>
		</http:request>
		<set-variable value="#[payload]"
			doc:name="Current Item"
			doc:id="9a0b490b-d930-40c3-8180-dcef450af5b9"
			variableName="currentItem" />
		<logger level="INFO" doc:name="Logger" message="Conta Criada com sucesso na API!" />
		<db:insert config-ref="Database_Config" doc:name="Insert into DB">
					<db:sql><![CDATA[INSERT INTO mule_conta (conta_id, nome, saldo)
                    VALUES (:conta_id, :nome, :saldo);]]></db:sql>
					<db:input-parameters><![CDATA[ #[{
                    'conta_id': payload.contaId,
                    'nome': payload.nome,
                    'saldo': payload.saldo
                }]]]></db:input-parameters>
				</db:insert>
		<logger level="INFO" doc:name="Logger" message="#['Payload: ' ++ dw::Core::write(payload, 'application/json') ++ ' Vars: ' ++ dw::Core::write(vars, 'application/json')]" />
	</sub-flow>
</mule>